{
  # to use handle_path for prefixes, pmtiles_proxy must have a defined
  # position in the ordering of handlers.
  order pmtiles_proxy before reverse_proxy
  email ${MAPS_EMAIL}
}


(cors) {
  @cors_preflight{args.0} method OPTIONS
  @cors{args.0} header Origin {args.0}

  handle @cors_preflight{args.0} {
    header {
      Access-Control-Allow-Origin "{args.0}"
      Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
      Access-Control-Allow-Headers *
      Access-Control-Max-Age "3600"
      defer
    }
    respond "" 204
  }

  handle @cors{args.0} {
    header {
      Access-Control-Allow-Origin "{args.0}"
      Access-Control-Expose-Headers *
      defer
    }
  }
}

${MAPS_DOMAIN} {
  import cors https://${MAPS_SERVE_DOMAIN}
  import cors https://www.${MAPS_SERVE_DOMAIN}
  import cors https://*.${MAPS_SERVE_DOMAIN}
  handle_path /tiles/* {
    pmtiles_proxy {
      bucket ${MAPS_PMTILES_LOCATION}
      cache_size 19000
      # used to embed a tiles URL in TileJSON.
      public_url https://${MAPS_DOMAIN}/tiles
    }
  }
}
